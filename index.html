<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wie war nochmal die Frage? ‚Äì Mini Game (v24 ‚Äì Review & Score)</title>
<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
body { margin:0; background:#0b0b0f; color:#f4f4f6; }
.wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
h1 { margin: 8px 0 12px; font-size: 22px; }
.card { background:#151521; border:1px solid #26263a; border-radius: 14px; padding: 14px; margin: 12px 0; }
.row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between; }
.row-left { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
.muted { color:#b9b9c6; font-size: 13px; }
.btn { border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; background:#4a7dff; color:#fff; }
.btn.secondary { background:#2a2a3f; }
.btn.danger { background:#ff4a6a; }
.btn:disabled { opacity:.5; cursor:not-allowed; }
.hr { height:1px; background:#26263a; margin: 12px 0; }
.kgrid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px; }
label.cat {
  background:#10101a; padding:10px 12px; border-radius:12px; border:1px solid #26263a; cursor:pointer; user-select:none;
  display:flex; gap:10px; align-items:flex-start;
}
label.cat:hover { border-color:#3a3a57; }
input[type="text"], input[type="range"]{
  background:#10101a; color:#fff; border:1px solid #26263a; border-radius:10px; padding:8px 10px; outline:none;
}
input[type="text"]:focus { border-color:#3a3a57; }
input[type="checkbox"]{ transform: translateY(2px); }
input[type="range"]{ width:180px; }
.pill { display:inline-flex; gap:10px; align-items:center; padding: 8px 12px; border-radius:999px; border:1px solid #26263a; background:#10101a; }
.stats { display:flex; gap:10px; flex-wrap: wrap; }
.stat { padding: 8px 12px; border-radius: 12px; background:#10101a; border:1px solid #26263a; min-width: 140px; }
.stat b { display:block; font-size: 18px; }
.bigQ { font-size:26px; font-weight:900; line-height:1.25; margin:10px 0; }
.hidden { display:none !important; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px 10px; border-bottom:1px solid #26263a; text-align:left; }
th { color:#b9b9c6; font-size: 12px; text-transform: uppercase; letter-spacing:.08em; }
.badge { padding:2px 8px; border-radius:999px; border:1px solid #26263a; background:#10101a; display:inline-block; }
.diag { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; white-space:pre-wrap; color:#d8d8e6; }
small { color:#b9b9c6; }

/* --- Fullscreen Game Overlay (Cinematic Mode) --- */
#gameOverlay.hidden { display:none !important; }
#gameOverlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,0.78);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
#gameOverlay .panel{
  width: min(980px, 100%);
  border: 1px solid #26263a;
  background: rgba(16,16,26,0.92);
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.45);
}
#gameOverlay .topbar{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}
#gameOverlay .timerbox{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid #26263a;
  background: rgba(16,16,26,0.9);
  font-weight: 800;
}
#gameOverlay .progressbox{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid #26263a;
  background: rgba(16,16,26,0.9);
  color:#b9b9c6;
}
#gameOverlay .cat{
  color:#b9b9c6;
  font-size: 14px;
  margin-top: 6px;
}
#gameOverlay .q{
  font-size: clamp(26px, 4.4vw, 44px);
  font-weight: 950;
  line-height: 1.15;
  margin: 14px 0 18px;
  letter-spacing: -0.01em;
}
#gameOverlay .actions{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: flex-end;
  margin-top: 6px;
}
#gameOverlay .hint{
  color:#b9b9c6;
  font-size: 12px;
  margin-top: 8px;
}
#overlayEnd.hidden{ display:none !important; }
#overlayEnd .q{ margin: 10px 0 6px; }
#overlayEnd .finalTime{
  font-size: clamp(34px, 6vw, 56px);
  font-weight: 950;
  margin: 6px 0 10px;
}
#gameOverlay .btn.big{
  padding: 14px 18px;
  font-size: 16px;
  border-radius: 14px;
}

</style>
</head>
<body>

<div id="gameOverlay" class="hidden" aria-hidden="true">
  <div class="panel">
    <div class="topbar">
      <div class="progressbox">üìå <b><span id="ovProgress">0</span>/<span id="ovTotal">0</span></b></div>
      <div class="timerbox">‚è± <span id="ovTime">00:00.0</span></div>
    </div>

    <div id="overlayPlay">
      <div class="cat" id="ovCat">Kategorie: ‚Äì</div>
      <div class="q" id="ovQuestion">‚Äî</div>
      <div class="actions">
        <button class="btn secondary big" id="ovExitBtn" type="button">‚§´ Abbrechen</button>
        <button class="btn big" id="ovNextBtn" type="button">‚û° Weiter</button>
      </div>
      <div class="hint">Antwort so kurz wie m√∂glich. <b>Keine Hauptw√∂rter aus der Frage!</b></div>
    </div>

    <div id="overlayEnd" class="hidden">
      <div class="cat">‚úÖ Runde beendet</div>
      <div class="q">Eure Zeit</div>
      <div class="finalTime" id="ovFinalTime">00:00.0</div>
      <div class="actions">
        <button class="btn secondary big" id="ovCloseBtn" type="button">‚úì Zur√ºck</button>
      </div>
      <div class="hint">Highscore wurde gespeichert (lokal auf diesem Ger√§t).</div>
    </div>
  </div>
</div>

<div class="wrap">
  <h1>üé¨ ‚ÄûWie war nochmal die Frage?‚Äú ‚Äì Mini Game</h1>

  <div class="card" id="setupCard">
    <div class="row">
      <div class="row-left">
        <div>
          <div class="muted">1) Kategorien ausw√§hlen</div>
          <div><b id="selectedCatsCount">0</b> Kategorien aktiv</div>
        </div>

        <div class="pill" title="Teamname">
          <span>üë• Team</span>
          <input id="teamName" type="text" placeholder="z.B. ChaosCrew" maxlength="24" style="width:180px;">
        </div>

        <div class="pill" title="Anzahl der Fragen pro Runde">
          <span>üéØ Spiell√§nge</span>
          <input id="lenRange" type="range" min="3" max="10" step="1" value="5">
          <b><span id="lenLabel">5</span> Fragen</b>
        </div>
      </div>

      <div class="row-left">
        <button class="btn secondary" id="selectAllBtn" type="button">Alle</button>
        <button class="btn secondary" id="selectNoneBtn" type="button">Keine</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kgrid" id="categoryList"></div>

    <div class="muted" style="margin-top:10px;">
      Kategorien/Fragen kommen aus der <b>zuletzt importierten</b> TXT-Datei.
      Nur <b>Alltagsfragen</b> bleibt immer erhalten und kann durch Import erg√§nzt werden.
      <br><small>Tipp: Wenn du ‚ÄûBasisfragen‚Äú nicht siehst, hast du evtl. noch alte Alltagsfragen im Browser gespeichert ‚Üí Button ‚ÄûAlltagsfragen leeren‚Äú und Seite neu laden.</small>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="stats">
        <div class="stat"><span class="muted">‚è± Zeit</span><b id="timeLabel">00:00.0</b></div>
        <div class="stat"><span class="muted">üìå Fortschritt</span><b><span id="progressLabel">0</span>/<span id="totalLabel">0</span></b></div>
      </div>
      <div class="row-left">
        <button class="btn" id="startBtn" type="button">‚ñ∂ Start</button>
        <button class="btn secondary" id="nextBtn" type="button" disabled>‚û° Weiter</button>
        <button class="btn danger" id="resetBtn" type="button" disabled>‚Ü∫ Reset</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="gameArea" class="hidden">
      <div class="muted" id="catOfQuestion">Kategorie: ‚Äì</div>
      <div class="bigQ" id="questionText">‚Äî</div>
      <div class="muted">Weiter = n√§chste Frage. Nach der letzten Frage stoppt die Zeit automatisch.</div>
    </div>

    
    <div id="endArea" class="hidden">
      <div class="bigQ">‚úÖ Runde beendet!</div>
      <div class="muted">Eure Zeit:</div>
      <div style="font-size:34px;font-weight:900;margin-top:6px" id="finalTime">00:00.0</div>

      <div class="hr" style="margin:14px 0;"></div>
      <div class="muted"><b>Jetzt auswerten:</b> Hakt an, welche Fragen ihr richtig erraten habt.</div>
      <div class="row" style="margin-top:10px;">
        <div class="row-left">
          <span class="badge">Richtig: <b><span id="scoreLabel">0</span></b> / <span id="scoreTotal">0</span></span>
          <button class="btn secondary" id="markAllBtn" type="button">Alle richtig</button>
          <button class="btn secondary" id="markNoneBtn" type="button">Alle falsch</button>
        </div>
        <div class="row-left">
          <button class="btn" id="saveResultBtn" type="button">üèÅ Ergebnis speichern</button>
        </div>
      </div>

      <div id="reviewList" style="margin-top:10px;"></div>
      <div class="muted" id="saveHint" style="margin-top:10px;">Erst nach dem Speichern landet ihr im Highscore.</div>
    </div>

    <div id="warnArea" class="muted hidden" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div><b>TXT Import / Export</b></div>
        <div class="muted">Format: <span class="badge">#category: Name</span> und darunter Fragen. Ohne Kategorie ‚Üí Alltagsfragen.</div>
      </div>
      <div class="row-left">
        <input type="file" id="importFile" accept=".txt,text/plain">
        <button class="btn secondary" id="exportAllBtn" type="button">Export: alles</button>
        <button class="btn secondary" id="exportAlltagBtn" type="button">Export: Alltagsfragen</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="row-left">
        <button class="btn secondary" id="clearImportBtn" type="button">Letzten Import l√∂schen</button>
        <button class="btn danger" id="clearAlltagBtn" type="button">Alltagsfragen leeren</button>
      </div>
      <div class="muted"><small>Export l√§dt eine .txt Datei herunter (l√§uft lokal im Browser).</small></div>
    </div>
  </div>

  <div class="card" id="individuellCard">
    <div class="row">
      <div>
        <div class="muted"><b>Eigene Fragen</b></div>
        <div class="muted">Direkte Eingabe ‚Üí Kategorie <span class="badge">Individuell</span>.</div>
      </div>
      <div class="row-left">
        <button class="btn secondary" id="indAddBtn" type="button">Hinzuf√ºgen</button>
        <button class="btn danger" id="indClearBtn" type="button">Individuell leeren</button>
      </div>
    </div>
    <div class="hr"></div>
    <textarea id="indInput" placeholder="Eine Frage pro Zeile‚Ä¶"></textarea>
    <div class="muted"><small>Leere Zeilen werden ignoriert. Duplikate werden entfernt. Umlaute bleiben erhalten.</small></div>
  </div>


  <div class="card" id="highscoreCard">
    <div class="row">
      <div>
        <div class="muted">üèÜ Highscores</div>
        <div><b id="hsMeta">‚Äì</b></div>
      </div>
      <div class="row-left">
        <button class="btn secondary" id="clearHsBtn" type="button">Liste l√∂schen</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="hsList" class="muted">Noch keine Eintr√§ge.</div>
  </div>

  <div class="card">
    <div class="muted"><b>Diagnose</b> (falls etwas nicht l√§dt):</div>
    <div class="diag" id="diagBox">Warte auf Initialisierung‚Ä¶</div>
  </div>
</div>

<script>
(() => {
  const log = (msg) => { document.getElementById("diagBox").textContent += "\\n" + msg; };
  window.addEventListener("error", (e) => log("JS ERROR: " + (e.message || e.error)));

  document.addEventListener("DOMContentLoaded", () => {
    const ALLTAG_KEY = "wwndf_alltagsfragen_v1";
    const IMPORT_KEY  = "wwndf_last_import_categories_v1";
    const IND_KEY     = "wwndf_individuell_v1";
    const TEAM_KEY    = "wwndf_last_team_v1";
    const HS_KEY      = "wwndf_highscores_v2";
    const HS_MAX      = 15;

    // Basis-Alltagsfragen (werden NUR gesetzt, wenn Alltagsfragen noch leer/nicht vorhanden sind)
    const BASE_ALLTAG = [
      "Wie geht es dir?",
      "Wie hei√üt du?",
      "Wie hei√üt dein Mitspieler?",
      "Was ist dein Lieblingsessen?",
      "Was ist dein Lieblingsgetr√§nk?",
      "Was ist deine Lieblingsstadt?",
      "Wohin m√∂chtest du mal reisen?",
      "Was machst du gar nicht?",
      "Was liebst du √ºber alles?",
      "Wo wohnst du?",
      "Wo arbeitest du?"
    ];

    const loadJSON = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); } catch { return fallback; } };
    const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    function normalizeQuestion(q){
      return String(q || "").trim().replace(/\s+/g, " ");
    }
    function dedupe(list){
      const seen = new Set();
      const out = [];
      for (const q of (list || [])) {
        const t = normalizeQuestion(q);
        if (!t) continue;
        if (seen.has(t)) continue;
        seen.add(t);
        out.push(t);
      }
      return out;
    }

    // --- Seed basis Alltagsfragen if missing/empty ---
    (function seedBaseAlltagIfNeeded(){
      const existingRaw = localStorage.getItem(ALLTAG_KEY);
      let existing = null;
      try { existing = existingRaw ? JSON.parse(existingRaw) : null; } catch { existing = null; }
      const existingClean = Array.isArray(existing) ? dedupe(existing) : [];
      if (!existingRaw || existingClean.length === 0) {
        saveJSON(ALLTAG_KEY, dedupe(BASE_ALLTAG));
        log("Seeded BASE Alltagsfragen (" + BASE_ALLTAG.length + ").");
      } else {
        log("Alltagsfragen vorhanden (" + existingClean.length + ") ‚Äì Basis nicht √ºberschrieben.");
      }
    })();

    function loadAlltag(){ return dedupe(loadJSON(ALLTAG_KEY, [])); }
    function saveAlltag(list){ saveJSON(ALLTAG_KEY, dedupe(list)); }

    function loadImportCats(){ return loadJSON(IMPORT_KEY, {}); }
    function saveImportCats(obj){ saveJSON(IMPORT_KEY, obj || {}); }

    function loadIndividuell(){ return dedupe(loadJSON(IND_KEY, [])); }
    function saveIndividuell(list){ saveJSON(IND_KEY, dedupe(list)); }

    function getBank(){
      const bank = {};
      bank["Alltagsfragen"] = loadAlltag();
      const ind = loadIndividuell();
      if (ind.length) bank["Individuell"] = ind;
      const imported = loadImportCats();
      for (const [cat, qs] of Object.entries(imported)) {
        if (!cat || cat === "Alltagsfragen") continue;
        bank[cat] = dedupe(qs || []);
      }
      return bank;
    }

    function getBankStats(){
      const bank = getBank();
      const cats = Object.keys(bank);
      const totalQs = cats.reduce((sum, c) => sum + (bank[c]?.length || 0), 0);
      return {cats: cats.length, totalQs, alltag: (bank["Alltagsfragen"]?.length || 0)};
    }

    const $ = (id) => document.getElementById(id);
    const categoryListEl = $("categoryList");

    function renderCategories(){
      const bank = getBank();
      const cats = Object.keys(bank);
      categoryListEl.innerHTML = "";

      for (const cat of cats) {
        const id = "cat_" + cat.replace(/[^a-z0-9]+/gi, "_");
        const count = bank[cat].length;

        const label = document.createElement("label");
        label.className = "cat";
        label.setAttribute("for", id);

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = true;
        cb.dataset.cat = cat;
        cb.addEventListener("change", syncSelectedCats);

        const txt = document.createElement("div");
        txt.innerHTML = `<b>${cat}</b><div class="muted">${count} Frage${count===1?"":"n"}</div>`;

        label.appendChild(cb);
        label.appendChild(txt);
        categoryListEl.appendChild(label);
      }
      syncSelectedCats();
    }

    function getSelectedCats(){
      return [...categoryListEl.querySelectorAll('input[type="checkbox"]')]
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.cat);
    }

    function syncSelectedCats(){
      const n = getSelectedCats().length;
      $("selectedCatsCount").textContent = String(n);
      $("startBtn").disabled = (n === 0) || state.running;
    }

    const teamNameEl = $("teamName");
    teamNameEl.value = localStorage.getItem(TEAM_KEY) || "";
    teamNameEl.addEventListener("input", () => localStorage.setItem(TEAM_KEY, teamNameEl.value.slice(0,24)));

    const lenRange = $("lenRange");
    const lenLabel = $("lenLabel");
    lenRange.addEventListener("input", () => lenLabel.textContent = lenRange.value);
    lenLabel.textContent = lenRange.value;

    const state = { running:false, startTs:0, timer:null, elapsed:0, deck:[], idx:0, total:5 };

    function formatTime(ms){
      const s = ms / 1000;
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      const t = Math.floor((ms % 1000) / 100);
      return String(m).padStart(2,"0")+":"+String(sec).padStart(2,"0")+"."+t;
    }

    function shuffle(arr){
      for (let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function buildDeck(selectedCats){
      const bank = getBank();
      let d = [];
      for (const cat of selectedCats) {
        const qs = bank[cat] || [];
        for (const q of qs) d.push({cat, text:q});
      }
      const seen = new Set();
      d = d.filter(x => (seen.has(x.text) ? false : (seen.add(x.text), true)));
      return shuffle(d);
    }

    function tick(){
      state.elapsed = performance.now() - state.startTs;
      const t = formatTime(state.elapsed);
      $("timeLabel").textContent = t;
      overlaySetTime(t);
    }

    function showQ(){
      const item = state.deck[state.idx];
      $("catOfQuestion").textContent = "Kategorie: " + item.cat;
      $("questionText").textContent = item.text;
      $("progressLabel").textContent = String(state.idx + 1);
      overlaySetQuestion(item.cat, item.text, state.idx + 1, state.total);
    }


    // ---------- Post-Game Review (score after the round) ----------
    function getAskedCards(){
      // Asked questions are the first `state.total` cards of the shuffled deck
      return (state.deck || []).slice(0, state.total || 0);
    }

    function renderReview(){
      const asked = getAskedCards();
      const listEl = $("reviewList");
      const totalEl = $("scoreTotal");
      const scoreEl = $("scoreLabel");
      const hintEl = $("saveHint");
      const saveBtn = $("saveResultBtn");

      totalEl.textContent = String(asked.length);
      scoreEl.textContent = "0";
      hintEl.textContent = "Erst nach dem Speichern landet ihr im Highscore.";
      saveBtn.disabled = asked.length === 0;

      if (!asked.length){
        listEl.innerHTML = '<div class="muted">Keine Fragen zum Auswerten gefunden.</div>';
        return;
      }

      const rows = asked.map((it, idx) => {
        const id = "chk_" + idx;
        return `
          <div class="row" style="align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid #26263a;">
            <div style="min-width:32px;"><b>${idx+1}.</b></div>
            <div style="flex:1;">
              <div class="muted" style="margin-bottom:4px;">${escapeHtml(it.cat)}</div>
              <div style="font-weight:800;">${escapeHtml(it.text)}</div>
            </div>
            <div style="min-width:120px;text-align:right;">
              <label style="display:inline-flex;gap:8px;align-items:center;cursor:pointer;">
                <input type="checkbox" id="${id}" data-idx="${idx}">
                <span>richtig</span>
              </label>
            </div>
          </div>
        `;
      }).join("");

      listEl.innerHTML = `<div style="border-top:1px solid #26263a;">${rows}</div>`;

      const updateScore = () => {
        const checks = listEl.querySelectorAll('input[type="checkbox"]');
        let s = 0;
        checks.forEach(ch => { if (ch.checked) s++; });
        scoreEl.textContent = String(s);
        return s;
      };

      listEl.addEventListener("change", (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) updateScore();
      }, { once: true });

      // Buttons: all / none
      $("markAllBtn").onclick = () => {
        listEl.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = true);
        updateScore();
      };
      $("markNoneBtn").onclick = () => {
        listEl.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = false);
        updateScore();
      };

      // Save result -> highscore
      $("saveResultBtn").onclick = () => {
        const score = updateScore();
        const timeText = $("finalTime").textContent;
        addHighscoreEntry({
          team: teamNameEl.value || "",
          timeMs: Math.round(state.elapsed),
          timeText,
          qCount: state.total,
          score
        });
        $("saveResultBtn").disabled = true;
        hintEl.textContent = "‚úÖ Gespeichert! Highscore aktualisiert.";
        log("Result saved. Score=" + score);
      };
    }

    function stopGame(){
      state.running = false;
      if (state.timer) clearInterval(state.timer);
      state.timer = null;
      tick();
      const timeText = $("timeLabel").textContent;
      $("finalTime").textContent = timeText;
      // Robust: close overlay at end and let evaluation happen on the end screen
      closeOverlay();
      renderReview();

      $("gameArea").classList.add("hidden");
      $("endArea").classList.remove("hidden");
      $("setupCard").classList.remove("hidden");

      $("nextBtn").disabled = true;
      $("startBtn").disabled = false;
      $("resetBtn").disabled = false;
      syncSelectedCats();
      log("Game stopped + Highscore saved.");
    }

    function resetUI(){
      closeOverlay();
      state.running = false;
      if (state.timer) clearInterval(state.timer);
      state.timer = null;
      state.elapsed = 0;
      state.deck = [];
      state.idx = 0;

      $("timeLabel").textContent = "00:00.0";
      $("progressLabel").textContent = "0";
      $("totalLabel").textContent = "0";
      $("gameArea").classList.add("hidden");
      $("endArea").classList.add("hidden");
      // clear review UI
      const rl = $("reviewList"); if (rl) rl.innerHTML = "";
      if ($("scoreLabel")) $("scoreLabel").textContent = "0";
      if ($("scoreTotal")) $("scoreTotal").textContent = "0";
      if ($("saveResultBtn")) $("saveResultBtn").disabled = true;
      if ($("saveHint")) $("saveHint").textContent = "";
      $("setupCard").classList.remove("hidden");

      $("startBtn").disabled = false;
      $("nextBtn").disabled = true;
      $("resetBtn").disabled = true;
      $("warnArea").classList.add("hidden");
      $("warnArea").textContent = "";
      syncSelectedCats();
      log("Reset done.");
    }

    $("selectAllBtn").addEventListener("click", () => {
      categoryListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      syncSelectedCats();
    });
    $("selectNoneBtn").addEventListener("click", () => {
      categoryListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      syncSelectedCats();
    });

    $("startBtn").addEventListener("click", () => {
      const selectedCats = getSelectedCats();
      if (!selectedCats.length) return;

      state.total = parseInt(lenRange.value, 10);
      state.deck = buildDeck(selectedCats);

      if (state.deck.length === 0) {
        $("warnArea").classList.remove("hidden");
        $("warnArea").textContent = "Keine Fragen in der Auswahl. Bitte importieren oder Alltagsfragen erg√§nzen.";
        return;
      }

      if (state.deck.length < state.total) {
        state.total = state.deck.length;
        $("warnArea").classList.remove("hidden");
        $("warnArea").textContent = "Hinweis: Zu wenig Fragen ‚Äì Spiell√§nge angepasst auf " + state.total + ".";
      } else {
        $("warnArea").classList.add("hidden");
        $("warnArea").textContent = "";
      }

      state.idx = 0;
      state.running = true;
      state.startTs = performance.now();
      state.elapsed = 0;

      $("timeLabel").textContent = "00:00.0";
      $("totalLabel").textContent = String(state.total);
      $("progressLabel").textContent = "1";

      $("setupCard").classList.add("hidden");
      openOverlay();
      $("endArea").classList.add("hidden");
      $("gameArea").classList.remove("hidden");

      $("startBtn").disabled = true;
      $("nextBtn").disabled = false;
      $("resetBtn").disabled = false;

      state.timer = setInterval(tick, 100);
      showQ();
      log("Game started. Deck=" + state.deck.length + ", total=" + state.total);
    });

    $("nextBtn").addEventListener("click", () => {
      if (!state.running) return;
      state.idx += 1;
      if (state.idx >= state.total) stopGame();
      else showQ();
    });

    $("resetBtn").addEventListener("click", resetUI);

    // TXT import: replace import categories; append to Alltagsfragen when lines outside #category
    const importInput = $("importFile");
    importInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          applyImportText(String(evt.target.result || ""));
          alert("Import abgeschlossen.");
        } catch (err) {
          alert("Import-Fehler: " + (err?.message || err));
          log("Import error: " + (err?.message || err));
        } finally {
          importInput.value = "";
        }
      };
      reader.readAsText(file);
    });

    function applyImportText(text){
      const lines = String(text || "").split(/\r?\n/);
      const importCats = {};
      let alltag = loadAlltag();
      let currentCat = "Alltagsfragen";

      for (let raw of lines) {
        const line = normalizeQuestion(raw);
        if (!line) continue;
        if (line.startsWith("#") && !line.toLowerCase().startsWith("#category:")) continue;

        if (line.toLowerCase().startsWith("#category:")) {
          currentCat = normalizeQuestion(line.split(":").slice(1).join(":")) || "Alltagsfragen";
          continue;
        }

        if (currentCat === "Alltagsfragen") alltag.push(line);
        else {
          if (!importCats[currentCat]) importCats[currentCat] = [];
          importCats[currentCat].push(line);
        }
      }

      saveAlltag(alltag);
      saveImportCats(importCats);

      renderCategories();
      resetUI();
      const stats = getBankStats();
      log("Import applied. Kategorien=" + stats.cats + ", Fragen=" + stats.totalQs + ", Alltagsfragen=" + stats.alltag);
    }

    $("clearImportBtn").addEventListener("click", () => {
      localStorage.removeItem(IMPORT_KEY);
      renderCategories();
      resetUI();
      log("Last import categories cleared.");
    });

    $("clearAlltagBtn").addEventListener("click", () => {
      if (!confirm("Alltagsfragen wirklich leeren? (Danach werden beim Neuladen wieder die Basisfragen gesetzt)")) return;
      saveAlltag([]);
      renderCategories();
      resetUI();
      log("Alltagsfragen cleared.");
    });

    // Export
    function bankToTxt({includeAlltag, includeImported}){
      const parts = [];
      parts.push("# Export ‚Äì Wie war nochmal die Frage?");
      const stats = getBankStats();
      parts.push(`# Stand: ${new Date().toLocaleString()}`);
      parts.push(`# Kategorien: ${stats.cats}, Fragen gesamt: ${stats.totalQs}, Alltagsfragen: ${stats.alltag}`);
      parts.push("");

      const bank = getBank();

      if (includeAlltag) {
        parts.push("#category: Alltagsfragen");
        for (const q of (bank["Alltagsfragen"] || [])) parts.push(q);
        parts.push("");
      }
      if (includeImported) {
        const cats = Object.keys(bank).filter(c => c !== "Alltagsfragen").sort((a,b)=>a.localeCompare(b));
        for (const cat of cats) {
          parts.push(`#category: ${cat}`);
          for (const q of (bank[cat] || [])) parts.push(q);
          parts.push("");
        }
      }
      return parts.join("\n").trim() + "\n";
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function safeFileStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    }

    $("exportAllBtn").addEventListener("click", () => {
      const txt = bankToTxt({includeAlltag:true, includeImported:true});
      downloadText(`wwndf_export_alles_${safeFileStamp()}.txt`, txt);
      log("Export all triggered.");
    });
    $("exportAlltagBtn").addEventListener("click", () => {
      const txt = bankToTxt({includeAlltag:true, includeImported:false});
      downloadText(`wwndf_export_alltagsfragen_${safeFileStamp()}.txt`, txt);
      log("Export Alltagsfragen triggered.");
    });
    // Individuell ‚Äì eigene Fragen hinzuf√ºgen
    $("indAddBtn").addEventListener("click", () => {
      const raw = ($("indInput").value || "");
      const lines = raw.split(/\r?\n/).map(s => normalizeQuestion(s)).filter(Boolean);
      if (!lines.length) { log("Individuell: keine Eingabe."); return; }
      const existing = loadIndividuell();
      const merged = dedupe(existing.concat(lines));
      saveIndividuell(merged);
      $("indInput").value = "";
      renderCategories();
      syncSelectedCats();
      log("Individuell: hinzugef√ºgt " + (merged.length - existing.length) + " (gesamt " + merged.length + ").");
    });

    $("indClearBtn").addEventListener("click", () => {
      saveIndividuell([]);
      renderCategories();
      syncSelectedCats();
      log("Individuell: geleert.");
    });


    // Highscores
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function loadHighscores(){ return loadJSON(HS_KEY, []); }
    function saveHighscores(list){ saveJSON(HS_KEY, list); }

    function renderHighscores(){
      const list = loadHighscores().map(e => ({...e, score: Number(e.score)||0})).sort((a,b) => (b.score - a.score) || (a.timeMs - b.timeMs)).slice(0, HS_MAX);
      saveHighscores(list);

      $("hsMeta").textContent = list.length ? `${list.length} Eintr√§ge (Top ${HS_MAX})` : "Noch keine Eintr√§ge";
      const hsList = $("hsList");
      if (!list.length) { hsList.textContent = "Noch keine Eintr√§ge."; return; }

      const rows = list.map((e, i) => `
        <tr>
          <td><b>#${i+1}</b></td>
          <td>${escapeHtml(e.team || "Ohne Namen")}</td>
          <td><span class="badge">${Number(e.score)||0}</span></td>
          <td><span class="badge">${escapeHtml(e.timeText)}</span></td>
          <td>${e.qCount}</td>
          <td class="muted">${escapeHtml(e.dateText)}</td>
        </tr>
      `).join("");

      hsList.innerHTML = `
        <table>
          <thead>
            <tr><th>Rang</th><th>Team</th><th>Richtig</th><th>Zeit</th><th>Fragen</th><th>Datum</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function addHighscoreEntry({team, timeMs, timeText, qCount, score}){
      const list = loadHighscores();
      const d = new Date();
      list.push({
        team: (team || "").trim().slice(0,24),
        timeMs: Number(timeMs) || 0,
        timeText: String(timeText || ""),
        qCount: Number(qCount) || 0,
        score: Number(score) || 0,
        dateText: d.toLocaleString()
      });
      saveHighscores(list);
      renderHighscores();
    }

    $("clearHsBtn").addEventListener("click", () => {
      localStorage.removeItem(HS_KEY);
      renderHighscores();
      log("Highscores cleared.");
    });

    // init
    renderCategories();
    renderHighscores();
    resetUI();

    // ---------- Fullscreen Overlay (Cinematic Mode) ----------
    var overlayEl = document.getElementById("gameOverlay");
    var overlayPlayEl = document.getElementById("overlayPlay");
    var overlayEndEl = document.getElementById("overlayEnd");
    var ovCatEl = document.getElementById("ovCat");
    var ovQEl = document.getElementById("ovQuestion");
    var ovTimeEl = document.getElementById("ovTime");
    var ovProgEl = document.getElementById("ovProgress");
    var ovTotalEl = document.getElementById("ovTotal");
    var ovFinalEl = document.getElementById("ovFinalTime");
    var ovNextBtn = document.getElementById("ovNextBtn");
    var ovExitBtn = document.getElementById("ovExitBtn");
    var ovCloseBtn = document.getElementById("ovCloseBtn");
    if (!overlayEl) { log("Overlay not found in DOM."); }
    else { overlayEl.style.display = "none"; }


    function openOverlay(){
      if (!overlayEl) return;
      overlayEl.classList.remove("hidden");
      overlayEl.style.display = "flex";
      overlayEl.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeOverlay(){
      if (!overlayEl) return;
      overlayEl.classList.add("hidden");
      overlayEl.style.display = "none";
      overlayEl.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      // reset overlay panes
      if (overlayPlayEl) overlayPlayEl.classList.remove("hidden");
      if (overlayEndEl) overlayEndEl.classList.add("hidden");
    }

    function overlaySetQuestion(cat, text, idx, total){
      if (ovCatEl) ovCatEl.textContent = "Kategorie: " + cat;
      if (ovQEl) ovQEl.textContent = text;
      if (ovProgEl) ovProgEl.textContent = String(idx);
      if (ovTotalEl) ovTotalEl.textContent = String(total);
    }
    function overlaySetTime(t){
      if (ovTimeEl) ovTimeEl.textContent = t;
    }
    function overlayShowEnd(timeText){
      if (overlayPlayEl) overlayPlayEl.classList.add("hidden");
      if (overlayEndEl) overlayEndEl.classList.remove("hidden");
      if (ovFinalEl) ovFinalEl.textContent = timeText;
      overlaySetTime(timeText);
    }

    // Overlay buttons
    if (ovNextBtn) ovNextBtn.addEventListener("click", () => {
      const nb = document.getElementById("nextBtn");
      if (nb) nb.click();
    });
    if (ovExitBtn) ovExitBtn.addEventListener("click", () => {
      closeOverlay();
      resetUI();
      log("Overlay: aborted.");
    });
    if (ovCloseBtn) ovCloseBtn.addEventListener("click", () => {
      closeOverlay();
      resetUI();
      log("Overlay: closed after end.");
    });

    // Tap background does nothing (avoid accidental skips)
    if (overlayEl) overlayEl.addEventListener("click", (e) => {
      if (e.target === overlayEl) {
        // ignore
      }
    });

    const stats = getBankStats();
    log(`Ready (v9). Kategorien=${stats.cats}, Fragen=${stats.totalQs}, Alltagsfragen=${stats.alltag}`);
  });
})();
</script>
</body>
</html>
